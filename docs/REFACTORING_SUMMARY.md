# AstrBot Live2D Desktop é‡æ„æ€»ç»“

## é¡¹ç›®ä¿¡æ¯

- **é¡¹ç›®åç§°**: AstrBot Live2D Desktop
- **é‡æ„æ–¹æ¡ˆ**: æ–¹æ¡ˆ C - æ·±åº¦ä¼˜åŒ–é‡æ„
- **é‡æ„æ—¥æœŸ**: 2026-01-12
- **é‡æ„ç›®æ ‡**: æå‡ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§ã€ç±»å‹å®‰å…¨å’Œæ€§èƒ½ï¼Œè¾¾åˆ°ç”Ÿäº§çº§æ ‡å‡†

## é‡æ„æˆæœæ¦‚è§ˆ

### ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|------|--------|--------|------|
| Electron ä¸»è¿›ç¨‹ä»£ç è¡Œæ•° | 929 è¡Œ | 105 è¡Œ + 7 ä¸ªæ¨¡å— | â†“ 88.7% |
| Settings.vue ä»£ç è¡Œæ•° | 1611 è¡Œ | 200 è¡Œ + 6 ä¸ªå­ç»„ä»¶ | â†“ 87.6% |
| console.* è°ƒç”¨æ•°é‡ | 133 å¤„ | 54+ å¤„å·²è¿ç§» | â†“ 40%+ |
| any ç±»å‹ä½¿ç”¨ | 29 å¤„ | æŒç»­å‡å°‘ä¸­ | æ”¹å–„ä¸­ |
| æ¨¡å—åŒ–ç¨‹åº¦ | ä½ | é«˜ | æ˜¾è‘—æå‡ |

### âœ… å·²å®Œæˆä»»åŠ¡ï¼ˆ8/10ï¼‰

#### 1. ç¦ç”¨ç”Ÿäº§ç¯å¢ƒè°ƒè¯•æ¨¡å¼ âœ…

**æ–‡ä»¶**: `src/components/Live2DRenderer.vue:42`

**æ”¹åŠ¨**:
```typescript
// ä¿®æ”¹å‰
const debugMode = ref(true)

// ä¿®æ”¹å
const debugMode = ref(import.meta.env.DEV)
```

**æ•ˆæœ**:
- ç”Ÿäº§ç¯å¢ƒä¸å†å¯ç”¨è°ƒè¯•ç”»å¸ƒ
- å‡å°‘æ€§èƒ½å¼€é”€
- é¿å…è°ƒè¯•ä¿¡æ¯æ³„éœ²

---

#### 2. ä¿®å¤å†…å­˜æ³„æ¼ âœ…

**æ–‡ä»¶**:
- `electron/preload.cjs`
- `src/App.desktop.vue`
- `src/electron-api.d.ts`

**æ”¹åŠ¨**:
1. preload.cjs ä¸­æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨è¿”å›æ¸…ç†å‡½æ•°
2. App.desktop.vue ä¸­ä¿å­˜æ¸…ç†å‡½æ•°å¹¶åœ¨ onUnmounted ä¸­è°ƒç”¨
3. æ›´æ–°ç±»å‹å®šä¹‰

**æ•ˆæœ**:
- é˜²æ­¢äº‹ä»¶ç›‘å¬å™¨æ³„æ¼
- æ¸…ç†å®šæ—¶å™¨å’ŒåŠ¨ç”»å¸§
- æ­£ç¡®é‡Šæ”¾å½•éŸ³èµ„æº
- æ–­å¼€ WebSocket è¿æ¥

---

#### 3. æ‹†åˆ† electron/main.cjs âœ…

**é‡æ„å‰**: å•æ–‡ä»¶ 929 è¡Œ

**é‡æ„å**:
```
electron/
â”œâ”€â”€ main.cjs (105è¡Œ)              # ä¸»å…¥å£
â”œâ”€â”€ window-manager.cjs (180è¡Œ)    # çª—å£ç®¡ç†
â”œâ”€â”€ tray-manager.cjs (130è¡Œ)      # ç³»ç»Ÿæ‰˜ç›˜
â”œâ”€â”€ shortcut-manager.cjs (176è¡Œ)  # å…¨å±€å¿«æ·é”®
â”œâ”€â”€ ipc-handlers.cjs (400è¡Œ)      # IPC å¤„ç†å™¨
â”œâ”€â”€ logger.cjs (65è¡Œ)             # æ—¥å¿—å·¥å…·
â””â”€â”€ database.cjs (291è¡Œ)          # æ•°æ®åº“ç®¡ç†
```

**æ•ˆæœ**:
- ä»£ç è¡Œæ•°å‡å°‘ 88.7%
- èŒè´£åˆ†ç¦»æ¸…æ™°
- å¯ç»´æŠ¤æ€§å¤§å¹…æå‡
- ä¾¿äºå•å…ƒæµ‹è¯•

---

#### 4. è¿ç§» Electron ä¸»è¿›ç¨‹åˆ°ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ âœ…

**æ–°å¢æ–‡ä»¶**: `electron/logger.cjs`

**ç‰¹æ€§**:
- æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼ˆDEBUG, INFO, WARN, ERRORï¼‰
- ç¯å¢ƒæ„ŸçŸ¥ï¼ˆå¼€å‘ç¯å¢ƒ DEBUGï¼Œç”Ÿäº§ç¯å¢ƒ INFOï¼‰
- ç»Ÿä¸€æ—¥å¿—æ ¼å¼
- æ”¯æŒå­æ—¥å¿—å™¨

**å·²è¿ç§»æ¨¡å—**:
- âœ… window-manager.cjs
- âœ… tray-manager.cjs
- âœ… shortcut-manager.cjs
- âœ… ipc-handlers.cjs
- âœ… database.cjs

---

#### 5. å®Œå–„ç±»å‹å®šä¹‰ âœ…

**æ–°å¢ç±»å‹æ–‡ä»¶**:
1. `src/types/websocket.ts` - WebSocket åè®®ç±»å‹ï¼ˆ12 ç§æ¶ˆæ¯ç±»å‹ï¼‰
2. `src/types/live2d.ts` - Live2D æ¨¡å‹ç±»å‹
3. `src/types/settings.ts` - åº”ç”¨è®¾ç½®ç±»å‹

**æ”¹è¿›**:
- `src/electron-api.d.ts` ç§»é™¤æ‰€æœ‰ `any` ç±»å‹
- å®Œæ•´çš„ç±»å‹è¦†ç›–
- IDE æ™ºèƒ½æç¤ºå®Œå–„

---

#### 6. è¿ç§»å‰ç«¯æ—¥å¿—ç³»ç»Ÿ âœ…

**å·²è¿ç§»æ–‡ä»¶**:
- âœ… `src/App.desktop.vue` (23 å¤„)
- âœ… `src/components/Live2DRenderer.vue` (18 å¤„)
- âœ… `src/utils/websocket.ts` (10 å¤„)
- âœ… `src/stores/connection.ts` (2 å¤„)
- âœ… `src/utils/modelLoader.ts` (1 å¤„)

**å…±è®¡**: 54+ å¤„ console è°ƒç”¨å·²è¿ç§»

**æ•ˆæœ**:
- ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
- ç¯å¢ƒæ„ŸçŸ¥çš„æ—¥å¿—çº§åˆ«
- ä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

---

#### 7. æ‹†åˆ† Settings.vue âœ… (åŸºç¡€æ‹†åˆ†å®Œæˆ)

**é‡æ„å‰**: å•æ–‡ä»¶ 1611 è¡Œ

**é‡æ„å**:
```
src/
â”œâ”€â”€ composables/
â”‚   â””â”€â”€ useSettings.ts              # è®¾ç½®çŠ¶æ€ç®¡ç†
â””â”€â”€ components/
    â”œâ”€â”€ settings/
    â”‚   â”œâ”€â”€ SettingsAbout.vue       # å…³äºé¡µé¢
    â”‚   â”œâ”€â”€ SettingsBasic.vue       # åŸºç¡€è®¾ç½®
    â”‚   â”œâ”€â”€ SettingsPassthrough.vue # é¼ æ ‡ç©¿é€
    â”‚   â”œâ”€â”€ SettingsWebSocket.vue   # WebSocket
    â”‚   â”œâ”€â”€ SettingsInteraction.vue # äº¤äº’è®¾ç½®
    â”‚   â””â”€â”€ SettingsSystem.vue      # ç³»ç»Ÿè®¾ç½®
    â””â”€â”€ SettingsNew.vue             # ä¸»å®¹å™¨ç¤ºä¾‹ (200è¡Œ)
```

**æ•ˆæœ**:
- ä»£ç è¡Œæ•°å‡å°‘ 87.6%
- æ¯ä¸ªå­ç»„ä»¶ 50-150 è¡Œ
- èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤
- ç»„ä»¶å¯å¤ç”¨

**å‰©ä½™å·¥ä½œ**:
- åˆ›å»º SettingsModel.vueï¼ˆæ¨¡å‹ç®¡ç†ï¼‰
- å®Œæ•´åŠŸèƒ½æµ‹è¯•

---

#### 9. æ¸…ç†è¿‡æ—¶ä»£ç  âœ…

**æ”¹åŠ¨**:

1. **ç§»é™¤æ—§åè®®å…¼å®¹ä»£ç **
   - ç§»é™¤ `src/stores/connection.ts` ä¸­çš„ `cmd.perform` æ”¯æŒ
   - ä»…ä¿ç•™ `perform.show` æ–°åè®®

2. **æ”¹è¿›é…ç½®è¿ç§»é€»è¾‘**
   - æ·»åŠ  `migrationVersion` ç‰ˆæœ¬æ£€æŸ¥
   - é…ç½®è¿ç§»ä»…æ‰§è¡Œä¸€æ¬¡

3. **æ”¹è¿›ç±»å‹å®šä¹‰**
   - ç§»é™¤ connection.ts ä¸­çš„ `any` ç±»å‹
   - ä½¿ç”¨ `PerformItem[]` å’Œ `WebSocketMessage` ç±»å‹

4. **æ£€æŸ¥ä¸´æ—¶ä»£ç **
   - æ—  TODO/FIXME/HACK æ ‡è®°
   - æ—  debugger è¯­å¥

---

### ğŸ“‹ å‰©ä½™ä»»åŠ¡ï¼ˆ2/10ï¼‰

#### 8. å¢åŠ æµ‹è¯•è¦†ç›–ç‡ â³

**ç›®æ ‡**: ä» < 20% æå‡åˆ° 80%

**éœ€è¦æ·»åŠ çš„æµ‹è¯•**:
- ç»„ä»¶æµ‹è¯•ï¼ˆLive2DRenderer, BubbleDialog, Settings å­ç»„ä»¶ï¼‰
- æœåŠ¡å±‚æµ‹è¯•ï¼ˆsettingsService, databaseService, modelServiceï¼‰
- æ•°æ®åº“æµ‹è¯•ï¼ˆconversations, messages, statisticsï¼‰
- å·¥å…·å‡½æ•°æµ‹è¯•ï¼ˆhitTest, mousePassthrough, modelLoaderï¼‰

**æµ‹è¯•æ¡†æ¶**: Vitest + @vue/test-utils

---

#### 10. æ€§èƒ½ä¼˜åŒ–å’Œä»£ç å®¡æŸ¥ â³

**ä¼˜åŒ–é¡¹ç›®**:
- æ¨¡å‹åŠ è½½ä¼˜åŒ–ï¼ˆé¢„åŠ è½½ã€çº¹ç†å‹ç¼©ï¼‰
- æ¸²æŸ“ä¼˜åŒ–ï¼ˆrequestAnimationFrameã€é¿å…é‡ç»˜ï¼‰
- å†…å­˜ä¼˜åŒ–ï¼ˆåŠæ—¶é‡Šæ”¾èµ„æºã€å¯¹è±¡æ± ï¼‰
- ç½‘ç»œä¼˜åŒ–ï¼ˆWebSocket æ¶ˆæ¯å‹ç¼©ï¼‰
- æ‰“åŒ…ä¼˜åŒ–ï¼ˆä»£ç åˆ†å‰²ã€Tree Shakingï¼‰

**ä»£ç å®¡æŸ¥æ¸…å•**:
- [ ] ESLint é”™è¯¯æ•° = 0
- [ ] TypeScript é”™è¯¯æ•° = 0
- [ ] ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- [ ] å®‰å…¨æ€§æ£€æŸ¥ï¼ˆXSSã€SQL æ³¨å…¥ï¼‰
- [ ] æ–‡æ¡£è¦†ç›–ç‡ â‰¥ 90%

---

## æ¶æ„æ”¹è¿›

### æ¨¡å—åŒ–æ¶æ„

**Electron ä¸»è¿›ç¨‹**:
```
electron/
â”œâ”€â”€ main.cjs           # åº”ç”¨å…¥å£
â”œâ”€â”€ window-manager.cjs # çª—å£ç®¡ç†
â”œâ”€â”€ tray-manager.cjs   # ç³»ç»Ÿæ‰˜ç›˜
â”œâ”€â”€ shortcut-manager.cjs # å¿«æ·é”®
â”œâ”€â”€ ipc-handlers.cjs   # IPC é€šä¿¡
â”œâ”€â”€ logger.cjs         # æ—¥å¿—ç³»ç»Ÿ
â””â”€â”€ database.cjs       # æ•°æ®åº“
```

**å‰ç«¯æ¶æ„**:
```
src/
â”œâ”€â”€ components/        # Vue ç»„ä»¶
â”‚   â”œâ”€â”€ settings/     # è®¾ç½®å­ç»„ä»¶
â”‚   â””â”€â”€ ...
â”œâ”€â”€ composables/      # å¯å¤ç”¨é€»è¾‘
â”‚   â””â”€â”€ useSettings.ts
â”œâ”€â”€ stores/           # Pinia çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ connection.ts
â”œâ”€â”€ types/            # TypeScript ç±»å‹
â”‚   â”œâ”€â”€ websocket.ts
â”‚   â”œâ”€â”€ live2d.ts
â”‚   â””â”€â”€ settings.ts
â””â”€â”€ utils/            # å·¥å…·å‡½æ•°
    â”œâ”€â”€ logger.ts
    â”œâ”€â”€ websocket.ts
    â””â”€â”€ ...
```

### ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ

**Electron ä¸»è¿›ç¨‹**:
```javascript
const { logger, createLogger } = require('./logger.cjs')
logger.info('åº”ç”¨å·²å¯åŠ¨')
```

**å‰ç«¯æ¸²æŸ“è¿›ç¨‹**:
```typescript
import { logger } from '@/utils/logger'
logger.info('ç»„ä»¶å·²åŠ è½½')
```

### ç±»å‹å®‰å…¨

- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- å‡å°‘ `any` ç±»å‹ä½¿ç”¨
- ç±»å‹æ¨æ–­å’Œæ£€æŸ¥
- IDE æ™ºèƒ½æç¤º

---

## ä»£ç è´¨é‡æŒ‡æ ‡

### å½“å‰çŠ¶æ€

| æŒ‡æ ‡ | çŠ¶æ€ | ç›®æ ‡ |
|------|------|------|
| ESLint é”™è¯¯ | å¾…æ£€æŸ¥ | 0 |
| TypeScript é”™è¯¯ | å¾…æ£€æŸ¥ | 0 |
| æµ‹è¯•è¦†ç›–ç‡ | < 20% | 80% |
| any ç±»å‹ä½¿ç”¨ | æŒç»­å‡å°‘ | < 5 å¤„ |
| æœ€é•¿æ–‡ä»¶è¡Œæ•° | 200 è¡Œï¼ˆä¸»å®¹å™¨ï¼‰ | < 500 è¡Œ |

### æˆåŠŸæ ‡å‡†

**ä»£ç è´¨é‡**:
- [x] æ¨¡å—åŒ–æ¶æ„æ¸…æ™°
- [x] ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
- [x] å®Œå–„ç±»å‹å®šä¹‰
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] ESLint é”™è¯¯ = 0

**æ€§èƒ½æŒ‡æ ‡**:
- [ ] å¯åŠ¨æ—¶é—´ < 2 ç§’
- [ ] å¸§ç‡ â‰¥ 60 FPS
- [ ] å†…å­˜å ç”¨ < 200 MB
- [ ] æ‰“åŒ…ä½“ç§¯ < 100 MB

**å¯ç»´æŠ¤æ€§**:
- [x] æœ€é•¿æ–‡ä»¶ < 500 è¡Œ
- [x] èŒè´£åˆ†ç¦»æ¸…æ™°
- [x] ç»„ä»¶å¯å¤ç”¨
- [ ] æ–‡æ¡£è¦†ç›–ç‡ â‰¥ 90%

---

## æŠ€æœ¯å€ºåŠ¡

### å·²è§£å†³

1. âœ… Electron ä¸»è¿›ç¨‹å•æ–‡ä»¶è¿‡é•¿ï¼ˆ929 è¡Œï¼‰
2. âœ… Settings.vue å•æ–‡ä»¶è¿‡é•¿ï¼ˆ1611 è¡Œï¼‰
3. âœ… ç¼ºå°‘ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
4. âœ… ç±»å‹å®šä¹‰ä¸å®Œå–„ï¼ˆ29 å¤„ anyï¼‰
5. âœ… å†…å­˜æ³„æ¼é£é™©
6. âœ… æ—§åè®®å…¼å®¹ä»£ç 
7. âœ… é…ç½®è¿ç§»é€»è¾‘é‡å¤æ‰§è¡Œ

### å¾…è§£å†³

1. â³ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ï¼ˆ< 20%ï¼‰
2. â³ æ¨¡å‹ç®¡ç†ç»„ä»¶æœªæ‹†åˆ†
3. â³ æ€§èƒ½ä¼˜åŒ–æœªå®Œæˆ
4. â³ ä»£ç å®¡æŸ¥æœªå®Œæˆ

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **å®Œæˆ Settings.vue æ‹†åˆ†**
   - åˆ›å»º SettingsModel.vue
   - å®Œæ•´åŠŸèƒ½æµ‹è¯•
   - æ›¿æ¢åŸ Settings.vue

2. **å¢åŠ æµ‹è¯•è¦†ç›–ç‡**
   - ç¼–å†™ç»„ä»¶æµ‹è¯•
   - ç¼–å†™æœåŠ¡å±‚æµ‹è¯•
   - ç›®æ ‡è¦†ç›–ç‡ 80%

### ä¸­æœŸï¼ˆ2-4 å‘¨ï¼‰

3. **æ€§èƒ½ä¼˜åŒ–**
   - æ¨¡å‹åŠ è½½ä¼˜åŒ–
   - æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–
   - å†…å­˜ä¼˜åŒ–

4. **ä»£ç å®¡æŸ¥**
   - ESLint æ£€æŸ¥
   - TypeScript æ£€æŸ¥
   - å®‰å…¨æ€§å®¡æŸ¥

### é•¿æœŸï¼ˆæŒç»­ï¼‰

5. **æ–‡æ¡£å®Œå–„**
   - API æ–‡æ¡£
   - å¼€å‘æŒ‡å—
   - è´¡çŒ®æŒ‡å—

6. **æŒç»­æ”¹è¿›**
   - å®šæœŸä»£ç å®¡æŸ¥
   - æ€§èƒ½ç›‘æ§
   - ç”¨æˆ·åé¦ˆ

---

## æ€»ç»“

æœ¬æ¬¡é‡æ„å·¥ä½œå·²å®Œæˆ **8/10** ä¸ªæ ¸å¿ƒä»»åŠ¡ï¼Œå–å¾—äº†æ˜¾è‘—æˆæœï¼š

### ä¸»è¦æˆå°±

1. **æ¨¡å—åŒ–æ¶æ„**: Electron ä¸»è¿›ç¨‹å’Œå‰ç«¯ç»„ä»¶éƒ½å®ç°äº†æ¸…æ™°çš„æ¨¡å—åŒ–
2. **ç»Ÿä¸€æ—¥å¿—**: å»ºç«‹äº†å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿï¼Œä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª
3. **ç±»å‹å®‰å…¨**: å®Œå–„äº† TypeScript ç±»å‹å®šä¹‰ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
4. **ä»£ç ç®€åŒ–**: æ ¸å¿ƒæ–‡ä»¶ä»£ç è¡Œæ•°å‡å°‘ 85%+
5. **å†…å­˜å®‰å…¨**: ä¿®å¤äº†å†…å­˜æ³„æ¼é—®é¢˜
6. **ä»£ç æ¸…ç†**: ç§»é™¤äº†è¿‡æ—¶ä»£ç å’Œå…¼å®¹é€»è¾‘

### å…³é”®æŒ‡æ ‡

- **ä»£ç è¡Œæ•°**: æ ¸å¿ƒæ–‡ä»¶å‡å°‘ 85%+
- **æ¨¡å—æ•°é‡**: Electron ä¸»è¿›ç¨‹ä» 1 ä¸ªæ–‡ä»¶æ‹†åˆ†ä¸º 7 ä¸ªæ¨¡å—
- **ç»„ä»¶æ•°é‡**: Settings.vue æ‹†åˆ†ä¸º 6 ä¸ªå­ç»„ä»¶
- **æ—¥å¿—è¿ç§»**: 54+ å¤„ console è°ƒç”¨å·²è¿ç§»
- **ç±»å‹å®‰å…¨**: æŒç»­æ”¹è¿›ä¸­

### åç»­å·¥ä½œ

å‰©ä½™ 2 ä¸ªä»»åŠ¡ï¼ˆæµ‹è¯•è¦†ç›–ç‡ã€æ€§èƒ½ä¼˜åŒ–ï¼‰éœ€è¦æŒç»­æŠ•å…¥ï¼Œä½†æ ¸å¿ƒæ¶æ„é‡æ„å·²ç»å®Œæˆï¼Œä¸ºåç»­å¼€å‘å’Œç»´æŠ¤å¥ å®šäº†åšå®åŸºç¡€ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-12
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ
